#!/usr/bin/env bash
# TODO:
#    Add --header to fzf
#    Customize --prompt in fzf
#    Customize --border settings in fzf
#


main() (
    if [ -z ${_SEARCH_ROOT_PATH+x} ]; then
        _SEARCH_ROOT_PATH="${PWD}"
    fi

    _inner_format() {
        _format "${HOME}" "${_SEARCH_ROOT_PATH}"
    }

    if [ -z ${_INITIAL_QUERY+x} ]; then
        _INITIAL_QUERY=$(echo "${PWD}" | _inner_format)
    fi

    cd "${_SEARCH_ROOT_PATH}" \
        && _fd ${_fd_extra_args[@]} \
            | _inner_format \
            | _fzf --query "${_INITIAL_QUERY}" ${_fzf_extra_args[@]} \
            | \
            (
                # the 'safe' way I know to spread stdin lines to positional arguments
                set --
                while IFS= read -r line; do
                    set -- "$@" "${line}"
                done
                _generate_command "$@"
            )
)


_fd() {
    fd \
        --hidden \
        --no-ignore \
        --exclude '.git' \
        --exclude 'node_modules' \
        "$@"
}



_fzf() {
    fzf \
        --color 'dark' \
        --height 80% \
        --layout reverse \
        --no-multi \
        --preview '_preview {}' \
        --preview-window 'right:60%' \
        --filepath-word \
        --bind 'tab:replace-query+top,shift-tab:backward-kill-word+top' \
        --expect='alt-m,alt-e,ctrl-g,esc,ctrl-m,enter' \
        "$@"
}


_preview() {
    if [ -d "$@" ]; then
        exa --color=always --icons --group-directories-first "$@"
    else
        bat \
            --style 'numbers,changes' \
            --color always \
            --italic-text always \
            "$@"
    fi
}


# Will format the relative paths given by _fd
# handle if prefix with root '/', home '~' or relative './'
# will also add trailing '/' when its directory
_format() {
    local home_path search_root_path prefix line
    home_path="${1}"
    search_root_path="${2}"
    prefix

    case "${search_root_path}" in
        "${home_path}") prefix='~';;
        '/') prefix='';;
        *) prefix='.';;
    esac

    while read -r line; do
        if [ -d "${line}" ]; then
            printf '%s/\n' "${prefix}/${line}"
        else
            printf '%s\n' "${prefix}/${line}"
        fi
    done
}


# ( exited_command, ...selected_files ) -> command_to_execute
_generate_command() {
    case "${1}" in
        'alt-m') printf 'setsid xdg-open %q </dev/null >/dev/null 2>&1' "${2/\~/${HOME}}";;
        'alt-e') printf 'pushd %q >/dev/null; "${EDITOR}" .' "${2/\~/${HOME}}";;
        'ctrl-g'|'esc') printf '';;
        'ctrl-m'|'enter') printf 'pushd %q >/dev/null' "${2/\~/${HOME}}";;
    esac
}


main
