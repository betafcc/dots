#!/usr/bin/env bash

if [ "$#" -ge 1 ]; then
    set -- --query "$@"
fi


fd \
    --type d \
    --hidden \
    --no-ignore \
    --exclude '.git' \
    --exclude 'node_modules' \
    | sed 's_$_/_' \
    | fzf \
          --color 'dark' \
          --height 80% \
          --layout reverse \
          --no-multi \
          --preview 'exa --color=always --icons {}' \
          --preview-window 'right:40%' \
          --filepath-word \
          --bind 'tab:replace-query+top,shift-tab:backward-kill-word+top' \
          --expect='alt-m,alt-e,ctrl-g,esc,ctrl-m,enter' \
          "$@" \
    | (
    set --
    while IFS= read -r REPLY; do
        set -- "$@" "${REPLY}"
    done

    case "${1}" in
        'alt-m') printf 'setsid xdg-open %q </dev/null >/dev/null 2>&1' "${2}";;
        'alt-e') printf 'pushd %q >/dev/null; "${EDITOR}" .' "${2}";;
        'ctrl-g'|'esc') printf '';;
        'ctrl-m'|'enter') printf 'pushd %q >/dev/null' "${2}";;
    esac
)
